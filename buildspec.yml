version: 0.2
phases:
  install:
    commands:
      - 'echo "Installing dependencies"'
      - apt-get update -y
      - DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential git clang flex bison gawk g++ libncurses5-dev libncursesw5-dev zlib1g-dev python3 python3-distutils rsync unzip file wget libssl-dev libelf-dev ccache
      - mkdir -p "$DL_DIR" "$CCACHE_DIR"
  pre_build:
    commands:
      - 'echo "Cloning OpenWrt: ${OPENWRT_REF}"'
      - 'git clone https://git.openwrt.org/openwrt/openwrt.git'
      - 'cd openwrt'
      - 'git checkout "${OPENWRT_REF}"'
      - './scripts/feeds update -a && ./scripts/feeds install -a'
      - 'echo "DL_DIR: $DL_DIR  CCACHE_DIR: $CCACHE_DIR"'
  build:
    commands:
      - echo "=== Generating .config for TARGET=${TARGET} SUBTARGET=${SUBTARGET} PROFILE=${PROFILE} ==="
      - wget https://downloads.openwrt.org/releases/24.10.2/targets/${TARGET}/${SUBTARGET}/config.buildinfo -o .config
      - mv config.buildinfo .config
      - make defconfig
      - ./scripts/feeds install -a
      - 'echo "=== Starting build ==="'
      - export CC="ccache gcc" CXX="ccache g++"
      - make -j"$(nproc)"
      - 'echo "commit=${CODEBUILD_RESOLVED_SOURCE_VERSION}" > build-info.txt'
      - 'echo "openwrt_ref=${OPENWRT_REF}" >> build-info.txt'
      - 'echo "target=${TARGET}" >> build-info.txt'
      - 'echo "subtarget=${SUBTARGET}" >> build-info.txt'
      - 'echo "profile=${PROFILE}" >> build-info.txt'
      - 'echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> build-info.txt'
      - 'echo "Syncing to s3://${IMAGES_BUCKET}/openwrt/${OPENWRT_REF}/${TARGET}_${SUBTARGET}/${PROFILE}/${CODEBUILD_RESOLVED_SOURCE_VERSION}/"'
      - 'aws s3 sync bin/ "s3://${IMAGES_BUCKET}/openwrt/${OPENWRT_REF}/${TARGET}_${SUBTARGET}/${PROFILE}/${CODEBUILD_RESOLVED_SOURCE_VERSION}/" --delete'
artifacts:
  files:
    - 'openwrt/build-info.txt'
    - 'openwrt/bin/**/*'
  discard-paths: no
